<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/three@0.131.3/examples/js/loaders/TDSLoader.js"></script>
  <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.3.0/dist/aframe-physics-system.min.js"></script>
</head>

<script>
  AFRAME.registerComponent("vr-controller", {
    init: function () {
      //トリガーを押した時に球を発射 
      this.el.addEventListener('triggerdown', function (e) {
        //コントローラの位置を取得(thisはコントローラ)
        var point = this.object3D.getWorldPosition();
        //ボールを生成
        var ball = document.createElement('a-sphere');
        ball.setAttribute('class', 'ball');
        ball.setAttribute('scale', '0.2 0.2 0.2');
        ball.setAttribute('position', point);
        //dynamic-bodyを設定することで物理演算をさせる
        ball.setAttribute('dynamic-body', 'shape: sphere; sphereRadius:0.2;');
        //コントローラのレイキャスターの向きを取得
        var dir = this.getAttribute("raycaster").direction;
        //球を発射するときの向きと大きさを設定(好みに応じて変更) 
        var force = new THREE.Vector3(dir.x, dir.y, dir.z);
        force.multiplyScalar(2000);
        //レイキャスターの向きはコントローラを原点としたローカル座標系なのでワールド座標に変換                   
        ball.force = this.object3D.localToWorld(force);
        //上記の設定を済ませた球をシーンに登場させる
        var scene = document.querySelector('a-scene');
        scene.appendChild(ball);
        //物理関係の設定が済んだタイミングで球を飛ばす 
        ball.addEventListener('body-loaded', function (e) {
          //ボールの位置を取得(ここでのthisはballを示す)
          var p = this.object3D.position;
          //加える力は先ほど計算したものを使用
          var f = this.force;
          //球に力を加えて飛ばす
          this.body.applyForce(
            new CANNON.Vec3(f.x, f.y, f.z),
            new CANNON.Vec3(p.x, p.y, p.z)
          );
        });

        // 衝突イベントリスナーを追加
        ball.addEventListener('collide', function (e) {
          var collidedObject = e.detail.body.el; // 衝突したオブジェクト
          console.log('Ball collided with', collidedObject);

          // 衝突したオブジェクトをシーンから削除
          if (collidedObject) {
            collidedObject.parentNode.removeChild(collidedObject);
          }
        });
      });

      const txt = document.getElementById("my_text");
      const el = this.el;
    },
  });
</script>

</head>

<body>
  <!-- <a-scene stats loading-screen="dotsColor: gray; backgroundColor: lightgray"> -->
  <a-scene physics="debug: false; gravity: 0; restitution: 0.9;">
    <a-assets timeout="9000">
      <a-asset-item id="dounut" src="./assets/dounut.glb"></a-asset-item>
      <a-asset-item id="akaei_standing" src="./assets/akaei-yellow.glb"></a-asset-item>
      <img id="360degreegb" src="./assets/puydesancy.jpg">
    </a-assets>

    <!-- Controller -->
    <a-entity laser-controls="hand: left" raycaster="objects: .collidable; far: 5" vr-controller></a-entity>
    <a-entity laser-controls="hand: right" raycaster="objects: .collidable; far: 5" vr-controller></a-entity>

    <!-- コントローラーの操作状況が分かるようにカメラにテキストを配置 -->
    <a-camera id="my_camera">
      <a-cursor></a-cursor>
      <a-text id="my_text" value="**40** aframe 1.0.4 **" position="0 -0.1 -2" scale="0.4 0.4 0.4" align="center"
        color="#ffffff"></a-text>
    </a-camera>

    <a-entity static-body gltf-model="#dounut" class="collidable" scale="2 2 2" rotation="0 -90 0" position="-1.5 0.5 -2.5"
      animation-mixer></a-entity>
    <!-- <a-entity static-body gltf-model="#akaei01" class="collidable" scale="1 1 1" rotation="0 30 0" position="-0.6 0.2 -1.1" animation-mixer></a-entity> -->
    <a-entity dynamic-body gltf-model="#akaei_standing" class="collidable" scale="1 1 1" rotation="0 0 0"
      position="1.3 0 -2.0" animation-mixer></a-entity>
    <a-entity static-body gltf-model="#akaei_standing" class="collidable" scale="1 1 1" rotation="0 0 0" position="-1.3 0.2 -1.0"
      animation-mixer></a-entity>

    <a-sky src="#360degreegb"></a-sky>
  </a-scene>
</body>

</html>
